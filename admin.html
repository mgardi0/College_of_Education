<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Û•Ú•Û•ÛŒ Ú©Û†Ù†ØªÚ•Û†Úµ - Ø¦Û•Ù†Ø¬Ø§Ù…Û•Ú©Ø§Ù†</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rudaw&display=swap');
        body { font-family: 'Rudaw', sans-serif; padding: 20px; background: #f4f4f4; text-align: center; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #4a90e2; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .btn { display: inline-block; padding: 10px 20px; background: #27ae60; color: white; text-decoration: none; border-radius: 5px; margin: 10px; border: none; cursor: pointer; font-size: 16px; }
        #loading { font-weight: bold; color: blue; margin-top: 20px; }
        #error-msg { color: red; font-weight: bold; display: none; margin-top: 20px; padding: 10px; background: #ffe6e6; border: 1px solid red; }
    </style>
</head>
<body>

    <div class="container" id="main-content" style="display:none;">
        <h1>Ù„ÛŒØ³ØªÛŒ Ù†Ù…Ø±Û•ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†</h1>
        <p id="total-count" style="font-weight: bold;">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø´Ø¯Ø§Ø±Ø¨ÙˆÙˆØ§Ù†: ...</p>
        
        <button onclick="exportToExcel()" class="btn">ğŸ“¥ Ø¯Ø§Ú¯Ø±ØªÙ†ÛŒ Ø¦Û•Ú©Ø³Úµ (Excel)</button>
        <button onclick="location.reload()" class="btn" style="background:#f39c12">ğŸ”„ Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>

        <p id="loading">â³ Ø®Û•Ø±ÛŒÚ©Û• Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¯Û•Ù‡ÛÙ†ÛØª...</p>
        <p id="error-msg"></p>

        <table id="results-table">
            <thead>
                <tr>
                    <th>Ù†Ø§Ùˆ</th>
                    <th>Ø¨Û•Ø´</th>
                    <th>Ù†Ù…Ø±Û•</th>
                    <th>Ú©Ø§Øª</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // ØªØ¹Ø±ÛŒÙÚ©Ø±Ø¯Ù†ÛŒ Ú¯Û†Ú•Ø§ÙˆÛ•Ú©Ø§Ù† Ù„Û• Ø³Û•Ø±Û•ØªØ§ÙˆÛ• (Ø¨Û† Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©ÛØ´Û•Ú©Û•)
        let db;
        let finalData = [];

        // Ù¡. Ù¾Ø§Ø³Û†Ø±Ø¯
        const password = prompt("Ù¾Ø§Ø³Û†Ø±Ø¯ Ú†ÛŒÛŒÛ•ØŸ (1234)");
        
        if (password === "1234") {
            document.getElementById('main-content').style.display = 'block';
            // Ú•Ø§Ø³ØªÛ•ÙˆØ®Û† ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³ Ø¦ÛŒØ´ Ù¾Û Ø¯Û•Ú©Û•ÛŒÙ†
            startApp();
        } else {
            document.body.innerHTML = "<h1 style='color:red; margin-top:50px;'>â›” Ù‡Û•ÚµÛ•ÛŒÛ•ØŒ Ú•ÛÚ¯Û•Ù¾ÛØ¯Ø±Ø§Ùˆ Ù†ÛŒÛŒÛ•</h1>";
        }

        function startApp() {
            const firebaseConfig = {
                apiKey: "AIzaSyBhv5zKnpk4DV1w_s9y2vbrv17Fmdyw1qs",
                authDomain: "college-of-education-f5c3e.firebaseapp.com",
                projectId: "college-of-education-f5c3e",
                storageBucket: "college-of-education-f5c3e.firebasestorage.app",
                messagingSenderId: "1014558650015",
                appId: "1:1014558650015:web:82a40961bfd5f750f4bcaa",
                measurementId: "G-1WJM3VEJQH"
            };

            try {
                // Ø¯ÚµÙ†ÛŒØ§Ø¨ÙˆÙˆÙ†Û•ÙˆÛ• Ù„Û•ÙˆÛ•ÛŒ ØªÛ•Ù†Ù‡Ø§ ÛŒÛ•Ú©Ø¬Ø§Ø± Ù¾ÛÙ†Ø§Ø³Û• Ø¯Û•Ú©Ø±ÛØª
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log("Firebase connected");
                fetchData();
            } catch (err) {
                showError("Ú©ÛØ´Û• Ù„Û• Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³: " + err.message);
            }
        }

        function fetchData() {
            const loading = document.getElementById('loading');
            const tbody = document.querySelector('#results-table tbody');
            
            // Ù‡ÛÙ†Ø§Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø§ØªØ§Ú©Ø§Ù†
            db.collection("results").get()
            .then((querySnapshot) => {
                loading.style.display = 'none';
                document.getElementById('total-count').innerText = "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø´Ø¯Ø§Ø±Ø¨ÙˆÙˆØ§Ù†: " + querySnapshot.size;
                
                tbody.innerHTML = "";
                finalData = []; // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù„ÛŒØ³ØªÛŒ Ú©Û†Ù†

                if (querySnapshot.empty) {
                    tbody.innerHTML = "<tr><td colspan='4'>Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</td></tr>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©ÛØ´Û•ÛŒ Ú©Ø§Øª
                    let timeDisplay = "Ù†Ø§Ø¯ÛŒØ§Ø±";
                    try {
                        if(data.timestamp && data.timestamp.toDate) {
                            timeDisplay = data.timestamp.toDate().toLocaleString('en-US'); 
                        } else if (data.timestamp) {
                            timeDisplay = data.timestamp.toString();
                        }
                    } catch(e) {
                        timeDisplay = "Ù‡Û•ÚµÛ• Ù„Û• Ú©Ø§Øª";
                    }

                    // Ø®Û•Ø²Ù†Ú©Ø±Ø¯Ù† Ø¨Û† Ø¦Û•Ú©Ø³Úµ
                    finalData.push({
                        Name: data.name || "Ø¨Û Ù†Ø§Ùˆ",
                        Department: data.department || "Ø¨Û Ø¨Û•Ø´",
                        Score: data.score || 0,
                        Time: timeDisplay
                    });

                    // Ù¾ÛŒØ´Ø§Ù†Ø¯Ø§Ù† Ù„Û• Ø®Ø´ØªÛ•
                    const row = `<tr>
                        <td>${data.name || '-'}</td>
                        <td>${data.department || '-'}</td>
                        <td style="font-weight:bold; color:${data.score >= 5 ? 'green' : 'red'}">${data.score}</td>
                        <td style="direction:ltr; font-size:12px;">${timeDisplay}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            })
            .catch((error) => {
                showError("Ù‡Û•ÚµÛ• Ù„Û• Ù‡ÛÙ†Ø§Ù†ÛŒ Ø¯Ø§ØªØ§: " + error.message);
            });
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            const errBox = document.getElementById('error-msg');
            errBox.style.display = 'block';
            errBox.innerText = msg;
        }

        function exportToExcel() {
            if(finalData.length === 0) { alert("Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛŒÛ• Ø¨Û† Ø¯Ø§Ú¯Ø±ØªÙ†!"); return; }
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM Ø¨Û† Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú©ÙˆØ±Ø¯ÛŒ
            csvContent += "Name,Department,Score,Time\n";

            finalData.forEach(row => {
                // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù†Ø§ÙˆÛ•Ú©Ø§Ù† Ù„Û• Ú©Û†Ù…Ø§ (,) Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø®Ø´ØªÛ•Ú©Û• ØªÛÚ© Ù†Û•Ø¯Ø§Øª
                let cleanName = row.Name.toString().replace(/,/g, " ");
                let r = `${cleanName},${row.Department},${row.Score},${row.Time}`;
                csvContent += r + "\r\n";
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Quiz_Results.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>

</body>
</html>
