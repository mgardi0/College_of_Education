<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Û•Ú•Û•ÛŒ Ú©Û†Ù†ØªÚ•Û†Úµ - Ø¦Û•Ù†Ø¬Ø§Ù…Û•Ú©Ø§Ù†</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rudaw&display=swap');
        body { font-family: 'Rudaw', sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #4a90e2; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .btn { display: block; width: 100%; padding: 10px; background: #27ae60; color: white; text-align: center; text-decoration: none; border-radius: 5px; margin-top: 20px; border: none; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #219150; }
        #loading { text-align: center; font-weight: bold; color: blue; }
    </style>
</head>
<body>

    <div class="container" id="main-content" style="display:none;">
        <h1>Ù„ÛŒØ³ØªÛŒ Ù†Ù…Ø±Û•ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†</h1>
        
        <p id="total-count">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø´Ø¯Ø§Ø±Ø¨ÙˆÙˆØ§Ù†: 0</p>
        
        <button onclick="downloadExcel()" class="btn">ðŸ“¥ Ø¯Ø§Ú¯Ø±ØªÙ†ÛŒ Ø¦Û•Ù†Ø¬Ø§Ù…Û•Ú©Ø§Ù† (Excel)</button>

        <table id="results-table">
            <thead>
                <tr>
                    <th>Ù†Ø§Ùˆ</th>
                    <th>Ø¨Û•Ø´</th>
                    <th>Ù†Ù…Ø±Û• (Ù„Û• Ù¡Ù )</th>
                    <th>Ú©Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <p id="loading">Ø®Û•Ø±ÛŒÚ©Û• Ø¯Ø§ØªØ§ Ø¯Û•Ù‡ÛŽÙ†ÛŽØª...</p>
    </div>

    <script>
        // Ù¡. Ù¾Ø§Ø±Ø§Ø³ØªÙ†ÛŒ Ù¾Û•Ú•Û•Ú©Û• (Ù¾Ø§Ø³Û†Ø±Ø¯)
        const password = prompt("ØªÚ©Ø§ÛŒÛ• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛŽÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•:");
        if (password === "1234") { // Ù„ÛŽØ±Û• Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ù¾Ø§Ø³Û†Ø±Ø¯Û•Ú©Û• Ø¨Ú¯Û†Ú•ÛŒØª
            document.getElementById('main-content').style.display = 'block';
            loadData();
        } else {
            alert("Ù¾Ø§Ø³Û†Ø±Ø¯ Ù‡Û•ÚµÛ•ÛŒÛ•!");
            document.body.innerHTML = "<h1 style='text-align:center; color:red;'>Ú•ÛŽÚ¯Û•Ù¾ÛŽØ¯Ø±Ø§Ùˆ Ù†ÛŒÛŒÛ•</h1>";
        }

        // Ù¢. ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³
        const firebaseConfig = {
            apiKey: "AIzaSyBhv5zKnpk4DV1w_s9y2vbrv17Fmdyw1qs",
            authDomain: "college-of-education-f5c3e.firebaseapp.com",
            projectId: "college-of-education-f5c3e",
            storageBucket: "college-of-education-f5c3e.firebasestorage.app",
            messagingSenderId: "1014558650015",
            appId: "1:1014558650015:web:82a40961bfd5f750f4bcaa",
            measurementId: "G-1WJM3VEJQH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allData = [];

        // Ù£. Ù‡ÛŽÙ†Ø§Ù†ÛŒ Ø¯Ø§ØªØ§
        function loadData() {
            const tbody = document.querySelector('#results-table tbody');
            const loading = document.getElementById('loading');
            
            db.collection("results").orderBy("timestamp", "desc").get().then((querySnapshot) => {
                loading.style.display = 'none';
                document.getElementById('total-count').innerText = "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø´Ø¯Ø§Ø±Ø¨ÙˆÙˆØ§Ù†: " + querySnapshot.size;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allData.push(data); // Ø®Û•Ø²Ù†Ú©Ø±Ø¯Ù† Ø¨Û† Ø¦ÛŽÚ©Ø³Úµ

                    // Ú©Ø§ØªÛ•Ú©Û• Ú•ÛŽÚ© Ø¯Û•Ø®Û•ÛŒÙ†
                    let timeString = "";
                    if (data.timestamp) {
                        const date = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                        timeString = date.toLocaleTimeString('en-US');
                    }

                    const row = `<tr>
                        <td>${data.name}</td>
                        <td>${data.department}</td>
                        <td>${data.score}</td>
                        <td style="direction:ltr">${timeString}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }).catch((error) => {
                loading.innerText = "Ù‡Û•ÚµÛ•: " + error.message;
                loading.style.color = "red";
            });
        }

        // Ù¤. Ø¯Ø§Ú¯Ø±ØªÙ† ÙˆÛ•Ú© Ø¦ÛŽÚ©Ø³Úµ
        function downloadExcel() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø®ÙˆÛŽÙ†ÛŽØªÛ•ÙˆÛ•
            csvContent += "Name,Department,Score,Time\n"; // Ø³Û•Ø±Ø¯ÛŽÚ•Û•Ú©Ø§Ù†

            allData.forEach(function(rowArray) {
                let timeStr = rowArray.timestamp && rowArray.timestamp.toDate ? rowArray.timestamp.toDate().toLocaleString() : "";
                let row = `${rowArray.name},${rowArray.department},${rowArray.score},${timeStr}`;
                csvContent += row + "\r\n";
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Result_College_Quiz.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
